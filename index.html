<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MicroEarn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Bengali:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           TELEGRAM-ONLY ACCESS BLOCK
           This check runs immediately on page load
        ============================================ */
        #telegramBlocked {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 9999;
            text-align: center;
            padding: 40px 20px;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* ============================================
           CSS VARIABLES FOR THEME SYSTEM
           Dark theme is default, light theme variables override
        ============================================ */
        :root {
            /* Dark Theme (Default) */
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #2d2d2d;
            --bg-overlay: rgba(0, 0, 0, 0.7);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --border-color: #404040;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --primary: #0088cc;
            --primary-light: rgba(0, 136, 204, 0.2);
            --primary-dark: #006699;
            --success: #00a884;
            --success-light: rgba(0, 168, 132, 0.2);
            --warning: #ff9500;
            --warning-light: rgba(255, 149, 0, 0.2);
            --danger: #ff3b30;
            --danger-light: rgba(255, 59, 48, 0.2);
            --info: #5856d6;
            --info-light: rgba(88, 86, 214, 0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --transition: all 0.3s ease;
            --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-family-bn: 'Noto Sans Bengali', 'Poppins', sans-serif;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --bg-overlay: rgba(0, 0, 0, 0.5);
            --text-primary: #1a1a1a;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border-color: #e9ecef;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            --primary: #0088cc;
            --primary-light: #e6f7ff;
            --primary-dark: #006699;
            --success: #00a884;
            --success-light: #e7f7f2;
            --warning: #ff9500;
            --warning-light: #fff4e6;
            --danger: #ff3b30;
            --danger-light: #ffe6e5;
            --info: #5856d6;
            --info-light: #f0f0ff;
        }

        /* ============================================
           BASE STYLES
        ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            height: 100%;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
            transition: var(--transition);
        }

        body.bn {
            font-family: var(--font-family-bn);
        }

        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* ============================================
           TYPOGRAPHY
        ============================================ */
        h1, h2, h3, h4 {
            font-weight: 600;
            line-height: 1.2;
        }

        .text-primary { color: var(--primary); }
        .text-success { color: var(--success); }
        .text-warning { color: var(--warning); }
        .text-danger { color: var(--danger); }
        .text-muted { color: var(--text-muted); }

        /* ============================================
           HEADER
        ============================================ */
        .app-header {
            background: var(--bg-primary);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(20px);
            background: rgba(var(--bg-primary-rgb), 0.9);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 1.125rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background: var(--border-color);
        }

        /* ============================================
           BALANCE CARD
        ============================================ */
        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-lg);
            padding: 24px;
            margin: 20px 0;
            color: white;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .balance-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .balance-sub {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* ============================================
           STATS GRID
        ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 24px 0;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ============================================
           SECTION HEADERS
        ============================================ */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 32px 0 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============================================
           QUICK ACTIONS
        ============================================ */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover:not(.disabled) {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .action-btn:nth-child(1) .action-icon { background: var(--primary-light); color: var(--primary); }
        .action-btn:nth-child(2) .action-icon { background: var(--success-light); color: var(--success); }
        .action-btn:nth-child(3) .action-icon { background: var(--warning-light); color: var(--warning); }
        .action-btn:nth-child(4) .action-icon { background: var(--info-light); color: var(--info); }

        .action-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .action-amount {
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* ============================================
           EARN CARDS
        ============================================ */
        .earn-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }

        .earn-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .earn-card:hover:not(.disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .earn-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .earn-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .earn-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .earn-card:nth-child(1) .earn-icon { background: var(--primary-light); color: var(--primary); }
        .earn-card:nth-child(2) .earn-icon { background: var(--success-light); color: var(--success); }
        .earn-card:nth-child(3) .earn-icon { background: var(--warning-light); color: var(--warning); }

        .earn-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .earn-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .earn-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .earn-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--success);
        }

        .cooldown {
            font-size: 0.75rem;
            color: var(--warning);
            padding: 4px 8px;
            background: var(--warning-light);
            border-radius: var(--radius-sm);
        }

        /* ============================================
           BOTTOM NAVIGATION
        ============================================ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            backdrop-filter: blur(20px);
            background: rgba(var(--bg-card-rgb), 0.95);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            min-width: 60px;
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        .nav-label {
            font-size: 0.6875rem;
            font-weight: 500;
        }

        /* ============================================
           PAGE CONTENT
           Single Page Application - show/hide sections
        ============================================ */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        /* ============================================
           HISTORY PAGE STYLES
        ============================================ */
        .history-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 4px;
            margin: 20px 0;
        }

        .history-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .history-tab.active {
            background: var(--primary);
            color: white;
        }

        .history-list {
            display: grid;
            gap: 12px;
        }

        .history-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .history-icon.ad { background: var(--primary-light); color: var(--primary); }
        .history-icon.survey { background: var(--success-light); color: var(--success); }
        .history-icon.daily { background: var(--warning-light); color: var(--warning); }
        .history-icon.withdrawal { background: var(--info-light); color: var(--info); }

        .history-details h4 {
            font-size: 0.875rem;
            margin-bottom: 4px;
        }

        .history-details p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .history-amount {
            font-weight: 600;
            font-size: 1rem;
        }

        .history-amount.positive {
            color: var(--success);
        }

        .history-amount.negative {
            color: var(--danger);
        }

        .history-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            margin-top: 4px;
        }

        .status-pending { background: var(--warning-light); color: var(--warning); }
        .status-completed { background: var(--success-light); color: var(--success); }
        .status-rejected { background: var(--danger-light); color: var(--danger); }

        /* ============================================
           MODALS
        ============================================ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 16px;
            backdrop-filter: blur(10px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            cursor: pointer;
        }

        /* ============================================
           LANGUAGE SELECTION MODAL
           First-time user flow for language selection
        ============================================ */
        .language-options {
            display: grid;
            gap: 12px;
            margin: 20px 0;
        }

        .language-btn {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
        }

        .language-btn:hover {
            background: var(--border-color);
        }

        .language-btn.active {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .language-flag {
            font-size: 2rem;
        }

        .language-info h3 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .language-info p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ============================================
           SETTINGS PAGE
        ============================================ */
        .settings-list {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin: 20px 0;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: var(--bg-secondary);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--primary-light);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-text h3 {
            font-size: 1rem;
            margin-bottom: 2px;
        }

        .settings-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .settings-value {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .theme-options {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theme-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            text-align: center;
        }

        .theme-btn.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        /* ============================================
           PROFILE SECTION
           Telegram user data display
        ============================================ */
        .profile-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 32px 0;
            text-align: center;
            color: white;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23006699' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
            margin-bottom: 12px;
        }

        .profile-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-username {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* ============================================
           REFERRAL SECTION
           With fallback UI if backend data is missing
        ============================================ */
        .referral-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 24px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .referral-code {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
            font-family: monospace;
            font-size: 1.125rem;
            letter-spacing: 1px;
            margin: 16px 0;
            cursor: pointer;
            user-select: all;
            border: 2px dashed var(--border-color);
        }

        /* ============================================
           LOADING & NOTIFICATIONS
           Error handling guards prevent spam
        ============================================ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border-color) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-md);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        /* ============================================
           ANIMATIONS
        ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            .balance-amount {
                font-size: 2rem;
            }
        }

        @media (max-width: 350px) {
            .quick-actions {
                grid-template-columns: 1fr;
            }
            .nav-label {
                display: none;
            }
        }

        /* ============================================
           UTILITY CLASSES
        ============================================ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            background: var(--primary);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        .btn-primary {
            background: var(--primary);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .text-center {
            text-align: center;
        }

        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
    </style>
</head>
<body>
    <!-- ============================================
         TELEGRAM-ONLY ACCESS BLOCK
         This runs immediately - blocks non-Telegram users
    ============================================ -->
    <div id="telegramBlocked">
        <div style="font-size: 3rem; margin-bottom: 24px;">ðŸš«</div>
        <h1 style="font-size: 1.5rem; margin-bottom: 16px;">This app can only be used inside Telegram</h1>
        <p style="margin-bottom: 24px; opacity: 0.9;">Please open this app through Telegram Mini App</p>
        <button onclick="location.reload()" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Reload Page
        </button>
    </div>

    <!-- ============================================
         LANGUAGE SELECTION MODAL
         First-time user flow for language selection
    ============================================ -->
    <div class="modal" id="languageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="choose_language">Choose Language</h2>
            </div>
            <div class="language-options">
                <div class="language-btn" data-lang="bn">
                    <div class="language-flag">ðŸ‡§ðŸ‡©</div>
                    <div class="language-info">
                        <h3>à¦¬à¦¾à¦‚à¦²à¦¾</h3>
                        <p>Bangla language</p>
                    </div>
                </div>
                <div class="language-btn" data-lang="en">
                    <div class="language-flag">ðŸ‡ºðŸ‡¸</div>
                    <div class="language-info">
                        <h3>English</h3>
                        <p>English language</p>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveLanguage()" style="width: 100%; margin-top: 20px; padding: 12px;">
                <span data-i18n="continue">Continue</span>
            </button>
        </div>
    </div>

    <!-- ============================================
         MAIN APP CONTENT
         Only shown if Telegram environment is detected
    ============================================ -->
    <div id="appContent" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-coins"></i>
                        <span>MicroEarn</span>
                    </div>
                    <div class="header-actions">
                        <button class="icon-btn" onclick="refreshData()" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content - Single Page Application -->
        <main class="container">
            <!-- ============================================
                 HOME / DASHBOARD PAGE
            ============================================ -->
            <div id="homePage" class="page active">
                <!-- Telegram User Profile Card -->
                <div id="profileSection" style="display: none;">
                    <div class="profile-header">
                        <img id="userAvatar" src="" alt="Avatar" class="profile-avatar skeleton">
                        <h2 class="profile-name" id="userName"></h2>
                        <p class="profile-username" id="userUsername"></p>
                    </div>
                </div>

                <!-- Balance Card -->
                <div class="balance-card skeleton" id="balanceCard">
                    <div class="balance-label" data-i18n="your_balance">Your Balance</div>
                    <div class="balance-amount" id="balanceAmount">0</div>
                    <div class="balance-sub" id="balanceSub">0 coins = 0 BDT</div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayEarnings">0</div>
                        <div class="stat-label" data-i18n="today">Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEarnings">0</div>
                        <div class="stat-label" data-i18n="total_earned">Total Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="referralCount">0</div>
                        <div class="stat-label" data-i18n="referrals">Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingWithdrawal">0</div>
                        <div class="stat-label" data-i18n="pending">Pending</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-bolt"></i>
                        <span data-i18n="quick_actions">Quick Actions</span>
                    </h3>
                </div>
                <div class="quick-actions">
                    <div class="action-btn" onclick="navigateTo('earnPage')">
                        <div class="action-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="action-amount" id="dailyBonusQuick">+50</div>
                        <div class="action-text" data-i18n="daily_bonus">Daily Bonus</div>
                    </div>
                    <div class="action-btn" onclick="watchAd('video_ad')" id="videoAdQuick">
                        <div class="action-icon">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="action-amount">+10</div>
                        <div class="action-text" data-i18n="watch_video">Watch Video</div>
                    </div>
                    <div class="action-btn" onclick="openReferralSection()">
                        <div class="action-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="action-amount">+50</div>
                        <div class="action-text" data-i18n="refer_friend">Refer Friend</div>
                    </div>
                    <div class="action-btn" onclick="navigateTo('walletPage')">
                        <div class="action-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="action-text" data-i18n="withdraw">Withdraw</div>
                    </div>
                </div>

                <!-- Earn More Section -->
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-gem"></i>
                        <span data-i18n="earn_more">Earn More</span>
                    </h3>
                </div>
                <div class="earn-grid">
                    <div class="earn-card" onclick="watchAd('video_ad')" id="videoAdCard">
                        <div class="earn-header">
                            <div class="earn-icon">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="earn-amount">+10</div>
                        </div>
                        <h3 class="earn-title" data-i18n="watch_video_ad">Watch Video Ad</h3>
                        <p class="earn-desc" data-i18n="video_ad_desc">Watch a short video to earn coins</p>
                        <div class="earn-footer">
                            <div class="cooldown" id="videoCooldown" data-i18n="ready">Ready!</div>
                            <button class="btn btn-sm" onclick="event.stopPropagation(); watchAd('video_ad')">
                                <span data-i18n="watch_now">Watch Now</span>
                            </button>
                        </div>
                    </div>

                    <div class="earn-card" onclick="claimDailyBonus()" id="dailyBonusCard">
                        <div class="earn-header">
                            <div class="earn-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <div class="earn-amount" id="dailyBonusAmount">+50</div>
                        </div>
                        <h3 class="earn-title" data-i18n="daily_bonus">Daily Bonus</h3>
                        <p class="earn-desc" data-i18n="daily_bonus_desc">Claim your daily bonus</p>
                        <div class="earn-footer">
                            <div class="cooldown" id="dailyBonusStatus" data-i18n="claim_now">Claim Now!</div>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); claimDailyBonus()">
                                <span data-i18n="claim">Claim</span>
                            </button>
                        </div>
                    </div>

                    <div class="earn-card" onclick="openSurveys()">
                        <div class="earn-header">
                            <div class="earn-icon">
                                <i class="fas fa-poll"></i>
                            </div>
                            <div class="earn-amount">+100-500</div>
                        </div>
                        <h3 class="earn-title" data-i18n="complete_surveys">Complete Surveys</h3>
                        <p class="earn-desc" data-i18n="survey_desc">Answer surveys and earn big rewards</p>
                        <div class="earn-footer">
                            <div class="cooldown" data-i18n="high_paying">High Paying</div>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); openSurveys()">
                                <span data-i18n="start">Start</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 EARN PAGE
            ============================================ -->
            <div id="earnPage" class="page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-money-bill-wave"></i>
                        <span data-i18n="earn_money">Earn Money</span>
                    </h3>
                </div>

                <div class="earn-grid" id="dynamicEarnGrid">
                    <!-- Dynamic earn cards will be loaded here -->
                </div>

                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        <span data-i18n="other_ways">Other Ways to Earn</span>
                    </h3>
                </div>

                <div class="settings-list">
                    <div class="settings-item" onclick="openSurveys()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-poll"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="surveys">Surveys</h3>
                                <p data-i18n="survey_earn_desc">Earn 100-500 coins per survey</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="settings-item" onclick="openReferralSection()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="referral_program">Referral Program</h3>
                                <p data-i18n="referral_earn_desc">Earn 50 coins for each friend</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 WALLET PAGE
            ============================================ -->
            <div id="walletPage" class="page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        <span data-i18n="wallet">Wallet</span>
                    </h3>
                </div>

                <div class="balance-card" style="margin-bottom: 32px;">
                    <div class="balance-label" data-i18n="available_balance">Available Balance</div>
                    <div class="balance-amount" id="walletBalance">0</div>
                    <div class="balance-sub" id="walletSub">0 coins = 0 BDT</div>
                </div>

                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-money-bill-transfer"></i>
                        <span data-i18n="withdraw_funds">Withdraw Funds</span>
                    </h3>
                </div>

                <div class="earn-card">
                    <h3 class="earn-title" data-i18n="withdraw_to_bank">Withdraw to bKash/Nagad</h3>
                    <p class="earn-desc" data-i18n="withdraw_desc">Minimum 1000 coins (100 BDT). Manual approval within 24-48 hours.</p>
                    <button class="btn btn-primary" onclick="openWithdrawModal()" style="width: 100%; margin-top: 16px; padding: 12px;">
                        <span data-i18n="request_withdrawal">Request Withdrawal</span>
                    </button>
                </div>

                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-clock"></i>
                        <span data-i18n="withdrawal_status">Withdrawal Status</span>
                    </h3>
                </div>

                <div id="withdrawalStatus">
                    <!-- Withdrawal status will be loaded here -->
                    <div class="earn-card" style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-hourglass-half" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 16px;"></i>
                        <h3 data-i18n="no_withdrawals">No Withdrawals Yet</h3>
                        <p class="earn-desc" data-i18n="request_withdrawal_first">Request your first withdrawal to see status</p>
                    </div>
                </div>
            </div>

            <!-- ============================================
                 HISTORY PAGE (NEW)
                 Shows task, survey, daily bonus, and withdrawal history
            ============================================ -->
            <div id="historyPage" class="page">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        <span data-i18n="transaction_history">Transaction History</span>
                    </h3>
                </div>

                <!-- History Tabs -->
                <div class="history-tabs">
                    <div class="history-tab active" onclick="showHistoryTab('all')" data-i18n="all">All</div>
                    <div class="history-tab" onclick="showHistoryTab('earnings')" data-i18n="earnings">Earnings</div>
                    <div class="history-tab" onclick="showHistoryTab('withdrawals')" data-i18n="withdrawals">Withdrawals</div>
                </div>

                <!-- History List -->
                <div class="history-list" id="historyList">
                    <!-- History items will be loaded here -->
                    <div class="earn-card" style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-history" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 16px;"></i>
                        <h3 data-i18n="no_history">No History Yet</h3>
                        <p class="earn-desc" data-i18n="start_earning">Start earning to see your transaction history</p>
                    </div>
                </div>

                <!-- Load More Button -->
                <div id="loadMoreHistory" style="display: none; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="loadMoreHistory()" style="width: 100%; padding: 12px;">
                        <span data-i18n="load_more">Load More</span>
                    </button>
                </div>
            </div>

            <!-- ============================================
                 SETTINGS PAGE
                 Contains language, theme, support, about, admin panel
            ============================================ -->
            <div id="settingsPage" class="page">
                <div class="profile-header">
                    <img id="profileAvatar" src="" alt="Avatar" class="profile-avatar skeleton">
                    <h2 class="profile-name" id="profileName"></h2>
                    <p class="profile-username" id="profileUsername"></p>
                </div>

                <div class="settings-list">
                    <!-- Language Setting -->
                    <div class="settings-item" onclick="openLanguageSettings()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-language"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="language">Language</h3>
                                <p data-i18n="change_app_language">Change app language</p>
                            </div>
                        </div>
                        <div class="settings-value" id="currentLanguage">English</div>
                    </div>

                    <!-- Theme Setting -->
                    <div class="settings-item" onclick="openThemeSettings()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="theme">Theme</h3>
                                <p data-i18n="change_app_theme">Change app theme</p>
                            </div>
                        </div>
                        <div class="settings-value" id="currentTheme">Dark</div>
                    </div>

                    <!-- Referral Section -->
                    <div class="settings-item" onclick="openReferralSection()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="referral_program">Referral Program</h3>
                                <p data-i18n="invite_friends_earn">Invite friends and earn coins</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <!-- Contact Support -->
                    <div class="settings-item" onclick="contactSupport()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="contact_support">Contact Support</h3>
                                <p data-i18n="get_help">Get help with any issues</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <!-- About Section -->
                    <div class="settings-item" onclick="openAbout()">
                        <div class="settings-item-left">
                            <div class="settings-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="about">About</h3>
                                <p data-i18n="about_microearn">About MicroEarn</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <!-- Admin Panel Button (Visible only for admins) -->
                    <div class="settings-item" id="adminPanelBtn" style="display: none;" onclick="openAdminPanel()">
                        <div class="settings-item-left">
                            <div class="settings-icon" style="background: var(--danger-light); color: var(--danger);">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="settings-text">
                                <h3 data-i18n="admin_panel">Admin Panel</h3>
                                <p data-i18n="admin_controls">Administrator controls</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>

                <!-- About Card (shown when About is clicked) -->
                <div class="referral-card" id="aboutCard" style="display: none;">
                    <h3 data-i18n="about_microearn">About MicroEarn</h3>
                    <p style="text-align: left; margin: 16px 0; line-height: 1.6;">
                        MicroEarn is a micro-task earning platform where users earn coins by completing tasks, surveys, and daily activities. Payments are processed manually to ensure safety and accuracy.
                    </p>
                    <button class="btn btn-primary" onclick="closeAbout()" style="width: 100%; margin-top: 16px; padding: 12px;">
                        <span data-i18n="close">Close</span>
                    </button>
                </div>

                <!-- Referral Card (shown when Referral is clicked) -->
                <div class="referral-card" id="referralCard" style="display: none;">
                    <h3 data-i18n="referral_program">Referral Program</h3>
                    <p style="margin: 16px 0;" data-i18n="referral_instructions">
                        Share your referral link with friends. When they join using your link, you'll earn 50 coins!
                    </p>
                    
                    <div class="referral-code" id="referralCode" onclick="copyReferralCode()">
                        Loading...
                    </div>
                    
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 8px 0;" data-i18n="tap_to_copy">
                        Tap to copy referral link
                    </p>
                    
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="shareReferral()" style="flex: 1;">
                            <i class="fas fa-share"></i>
                            <span data-i18n="share">Share</span>
                        </button>
                        <button class="btn" onclick="closeReferralSection()" style="flex: 1;">
                            <span data-i18n="close">Close</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navigateTo('homePage')">
                <i class="nav-icon fas fa-home"></i>
                <span class="nav-label" data-i18n="home">Home</span>
            </div>
            <div class="nav-item" onclick="navigateTo('earnPage')">
                <i class="nav-icon fas fa-coins"></i>
                <span class="nav-label" data-i18n="earn">Earn</span>
            </div>
            <div class="nav-item" onclick="navigateTo('walletPage')">
                <i class="nav-icon fas fa-wallet"></i>
                <span class="nav-label" data-i18n="wallet">Wallet</span>
            </div>
            <div class="nav-item" onclick="navigateTo('historyPage')">
                <i class="nav-icon fas fa-history"></i>
                <span class="nav-label" data-i18n="history">History</span>
            </div>
            <div class="nav-item" onclick="navigateTo('settingsPage')">
                <i class="nav-icon fas fa-user"></i>
                <span class="nav-label" data-i18n="settings">Settings</span>
            </div>
        </nav>

        <!-- ============================================
             MODALS
        ============================================ -->

        <!-- Withdraw Modal -->
        <div class="modal" id="withdrawModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-i18n="request_withdrawal">Request Withdrawal</h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="withdrawForm">
                    <!-- Form loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Theme Settings Modal -->
        <div class="modal" id="themeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-i18n="choose_theme">Choose Theme</h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="theme-options">
                    <button class="theme-btn active" data-theme="dark" onclick="changeTheme('dark')">
                        <i class="fas fa-moon"></i>
                        <div style="margin-top: 8px;" data-i18n="dark">Dark</div>
                    </button>
                    <button class="theme-btn" data-theme="light" onclick="changeTheme('light')">
                        <i class="fas fa-sun"></i>
                        <div style="margin-top: 8px;" data-i18n="light">Light</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Language Settings Modal -->
        <div class="modal" id="languageSettingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" data-i18n="choose_language">Choose Language</h3>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="language-options">
                    <div class="language-btn" data-lang="bn" onclick="setLanguage('bn')">
                        <div class="language-flag">ðŸ‡§ðŸ‡©</div>
                        <div class="language-info">
                            <h3>à¦¬à¦¾à¦‚à¦²à¦¾</h3>
                            <p>Bangla language</p>
                        </div>
                    </div>
                    <div class="language-btn" data-lang="en" onclick="setLanguage('en')">
                        <div class="language-flag">ðŸ‡ºðŸ‡¸</div>
                        <div class="language-info">
                            <h3>English</h3>
                            <p>English language</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notificationText"></span>
        </div>
    </div>

    <script>
        // ============================================
        // TELEGRAM-ONLY SECURITY CHECK
        // This runs immediately and blocks non-Telegram users
        // ============================================
        (function() {
            const blockedScreen = document.getElementById('telegramBlocked');
            const appContent = document.getElementById('appContent');
            
            // Critical check: Must have Telegram WebApp environment
            if (!window.Telegram || !window.Telegram.WebApp || !Telegram.WebApp.initData) {
                blockedScreen.style.display = 'flex';
                appContent.style.display = 'none';
                // Stop all further execution
                throw new Error('Telegram environment not detected');
            }
            
            // Telegram detected, show app
            blockedScreen.style.display = 'none';
            appContent.style.display = 'block';
            
            // Initialize Telegram WebApp
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.BackButton.hide();
        })();

        // ============================================
        // TRANSLATION SYSTEM (LANGUAGE HANDLING)
        // English and Bangla support with localStorage
        // ============================================
        const translations = {
            en: {
                // Navigation
                home: "Home",
                earn: "Earn",
                wallet: "Wallet",
                history: "History",
                settings: "Settings",
                
                // Common
                continue: "Continue",
                close: "Close",
                share: "Share",
                load_more: "Load More",
                success: "Success",
                error: "Error",
                warning: "Warning",
                
                // Language
                choose_language: "Choose Language",
                language: "Language",
                change_app_language: "Change app language",
                
                // Theme
                choose_theme: "Choose Theme",
                theme: "Theme",
                change_app_theme: "Change app theme",
                dark: "Dark",
                light: "Light",
                
                // Balance
                your_balance: "Your Balance",
                available_balance: "Available Balance",
                today: "Today",
                total_earned: "Total Earned",
                referrals: "Referrals",
                pending: "Pending",
                
                // Quick Actions
                quick_actions: "Quick Actions",
                daily_bonus: "Daily Bonus",
                watch_video: "Watch Video",
                refer_friend: "Refer Friend",
                withdraw: "Withdraw",
                
                // Earn
                earn_more: "Earn More",
                earn_money: "Earn Money",
                watch_video_ad: "Watch Video Ad",
                video_ad_desc: "Watch a short video to earn coins",
                watch_now: "Watch Now",
                daily_bonus_desc: "Claim your daily bonus",
                claim_now: "Claim Now",
                claim: "Claim",
                complete_surveys: "Complete Surveys",
                survey_desc: "Answer surveys and earn big rewards",
                high_paying: "High Paying",
                start: "Start",
                ready: "Ready!",
                
                // Wallet
                withdraw_funds: "Withdraw Funds",
                withdraw_to_bank: "Withdraw to bKash/Nagad",
                withdraw_desc: "Minimum 1000 coins (100 BDT). Manual approval within 24-48 hours.",
                request_withdrawal: "Request Withdrawal",
                withdrawal_status: "Withdrawal Status",
                no_withdrawals: "No Withdrawals Yet",
                request_withdrawal_first: "Request your first withdrawal to see status",
                
                // History
                transaction_history: "Transaction History",
                all: "All",
                earnings: "Earnings",
                withdrawals: "Withdrawals",
                no_history: "No History Yet",
                start_earning: "Start earning to see your transaction history",
                
                // Profile/Settings
                referral_program: "Referral Program",
                invite_friends_earn: "Invite friends and earn coins",
                referral_earn_desc: "Earn 50 coins for each friend",
                referral_instructions: "Share your referral link with friends. When they join using your link, you'll earn 50 coins!",
                tap_to_copy: "Tap to copy referral link",
                contact_support: "Contact Support",
                get_help: "Get help with any issues",
                about: "About",
                about_microearn: "About MicroEarn",
                
                // Admin
                admin_panel: "Admin Panel",
                admin_controls: "Administrator controls",
                
                // Notifications
                earned_coins: "Earned {{amount}} coins!",
                daily_bonus_claimed: "Daily bonus claimed! {{amount}} coins",
                insufficient_balance: "Insufficient balance",
                withdrawal_requested: "Withdrawal requested successfully",
                cooldown_active: "Cooldown active",
                already_claimed: "Already claimed today",
                copied_to_clipboard: "Copied to clipboard!",
                referral_copied: "Referral link copied!",
                
                // Surveys
                surveys: "Surveys",
                survey_earn_desc: "Earn 100-500 coins per survey",
                other_ways: "Other Ways to Earn"
            },
            bn: {
                // Navigation
                home: "à¦¹à§‹à¦®",
                earn: "à¦†à¦¯à¦¼ à¦•à¦°à§à¦¨",
                wallet: "à¦“à¦¯à¦¼à¦¾à¦²à§‡à¦Ÿ",
                history: "à¦‡à¦¤à¦¿à¦¹à¦¾à¦¸",
                settings: "à¦¸à§‡à¦Ÿà¦¿à¦‚à¦¸",
                
                // Common
                continue: "à¦šà¦¾à¦²à¦¿à¦¯à¦¼à§‡ à¦¯à¦¾à¦¨",
                close: "à¦¬à¦¨à§à¦§",
                share: "à¦¶à§‡à¦¯à¦¼à¦¾à¦° à¦•à¦°à§à¦¨",
                load_more: "à¦†à¦°à¦“ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨",
                success: "à¦¸à¦«à¦²",
                error: "à¦¤à§à¦°à§à¦Ÿà¦¿",
                warning: "à¦¸à¦¤à¦°à§à¦•à¦¤à¦¾",
                
                // Language
                choose_language: "à¦­à¦¾à¦·à¦¾ à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨",
                language: "à¦­à¦¾à¦·à¦¾",
                change_app_language: "à¦…à§à¦¯à¦¾à¦ªà§‡à¦° à¦­à¦¾à¦·à¦¾ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à§à¦¨",
                
                // Theme
                choose_theme: "à¦¥à¦¿à¦® à¦¨à¦¿à¦°à§à¦¬à¦¾à¦šà¦¨ à¦•à¦°à§à¦¨",
                theme: "à¦¥à¦¿à¦®",
                change_app_theme: "à¦…à§à¦¯à¦¾à¦ªà§‡à¦° à¦¥à¦¿à¦® à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦•à¦°à§à¦¨",
                dark: "à¦¡à¦¾à¦°à§à¦•",
                light: "à¦²à¦¾à¦‡à¦Ÿ",
                
                // Balance
                your_balance: "à¦†à¦ªà¦¨à¦¾à¦° à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸",
                available_balance: "à¦‰à¦ªà¦²à¦¬à§à¦§ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸",
                today: "à¦†à¦œ",
                total_earned: "à¦®à§‹à¦Ÿ à¦†à¦¯à¦¼",
                referrals: "à¦°à§‡à¦«à¦¾à¦°à§‡à¦²",
                pending: "à¦ªà§‡à¦¨à§à¦¡à¦¿à¦‚",
                
                // Quick Actions
                quick_actions: "à¦¦à§à¦°à§à¦¤ à¦•à¦¾à¦œ",
                daily_bonus: "à¦¦à§ˆà¦¨à¦¿à¦• à¦¬à§‹à¦¨à¦¾à¦¸",
                watch_video: "à¦­à¦¿à¦¡à¦¿à¦“ à¦¦à§‡à¦–à§à¦¨",
                refer_friend: "à¦¬à¦¨à§à¦§à§à¦•à§‡ à¦†à¦®à¦¨à§à¦¤à§à¦°à¦£ à¦•à¦°à§à¦¨",
                withdraw: "à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨",
                
                // Earn
                earn_more: "à¦†à¦°à¦“ à¦†à¦¯à¦¼ à¦•à¦°à§à¦¨",
                earn_money: "à¦Ÿà¦¾à¦•à¦¾ à¦†à¦¯à¦¼ à¦•à¦°à§à¦¨",
                watch_video_ad: "à¦­à¦¿à¦¡à¦¿à¦“ à¦¬à¦¿à¦œà§à¦žà¦¾à¦ªà¦¨ à¦¦à§‡à¦–à§à¦¨",
                video_ad_desc: "à¦•à¦¯à¦¼à§‡à¦¨ à¦ªà§‡à¦¤à§‡ à¦à¦•à¦Ÿà¦¿ à¦¸à¦‚à¦•à§à¦·à¦¿à¦ªà§à¦¤ à¦­à¦¿à¦¡à¦¿à¦“ à¦¦à§‡à¦–à§à¦¨",
                watch_now: "à¦à¦–à¦¨à¦‡ à¦¦à§‡à¦–à§à¦¨",
                daily_bonus_desc: "à¦†à¦ªà¦¨à¦¾à¦° à¦¦à§ˆà¦¨à¦¿à¦• à¦¬à§‹à¦¨à¦¾à¦¸ à¦¨à¦¿à¦¨",
                claim_now: "à¦à¦–à¦¨à¦‡ à¦¨à¦¿à¦¨",
                claim: "à¦¨à¦¿à¦¨",
                complete_surveys: "à¦¸à¦¾à¦°à§à¦­à§‡ à¦¸à¦®à§à¦ªà¦¨à§à¦¨ à¦•à¦°à§à¦¨",
                survey_desc: "à¦¸à¦¾à¦°à§à¦­à§‡ à¦‰à¦¤à§à¦¤à¦° à¦¦à¦¿à¦¯à¦¼à§‡ à¦¬à¦¡à¦¼ à¦ªà§à¦°à¦¸à§à¦•à¦¾à¦° à¦ªà¦¾à¦¨",
                high_paying: "à¦‰à¦šà§à¦š à¦†à¦¯à¦¼",
                start: "à¦¶à§à¦°à§ à¦•à¦°à§à¦¨",
                ready: "à¦ªà§à¦°à¦¸à§à¦¤à§à¦¤!",
                
                // Wallet
                withdraw_funds: "à¦Ÿà¦¾à¦•à¦¾ à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨",
                withdraw_to_bank: "bKash/Nagad-à¦ à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨",
                withdraw_desc: "à¦¨à§à¦¯à§‚à¦¨à¦¤à¦® à§§à§¦à§¦à§¦ à¦•à¦¯à¦¼à§‡à¦¨ (à§§à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾)à¥¤ à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦² à¦…à¦¨à§à¦®à§‹à¦¦à¦¨ à§¨à§ª-à§ªà§® à¦˜à¦¨à§à¦Ÿà¦¾à¦° à¦®à¦§à§à¦¯à§‡à¥¤",
                request_withdrawal: "à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨à§‡à¦° à¦…à¦¨à§à¦°à§‹à¦§",
                withdrawal_status: "à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨à§‡à¦° à¦…à¦¬à¦¸à§à¦¥à¦¾",
                no_withdrawals: "à¦à¦–à¦¨à¦“ à¦•à§‹à¦¨ à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨ à¦¨à§‡à¦‡",
                request_withdrawal_first: "à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨à§‡à¦° à¦…à¦¬à¦¸à§à¦¥à¦¾ à¦¦à§‡à¦–à¦¤à§‡ à¦ªà§à¦°à¦¥à¦® à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨à§‡à¦° à¦…à¦¨à§à¦°à§‹à¦§ à¦•à¦°à§à¦¨",
                
                // History
                transaction_history: "à¦²à§‡à¦¨à¦¦à§‡à¦¨à§‡à¦° à¦‡à¦¤à¦¿à¦¹à¦¾à¦¸",
                all: "à¦¸à¦¬",
                earnings: "à¦†à¦¯à¦¼",
                withdrawals: "à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨",
                no_history: "à¦à¦–à¦¨à¦“ à¦•à§‹à¦¨ à¦‡à¦¤à¦¿à¦¹à¦¾à¦¸ à¦¨à§‡à¦‡",
                start_earning: "à¦²à§‡à¦¨à¦¦à§‡à¦¨à§‡à¦° à¦‡à¦¤à¦¿à¦¹à¦¾à¦¸ à¦¦à§‡à¦–à¦¤à§‡ à¦†à¦¯à¦¼ à¦•à¦°à¦¾ à¦¶à§à¦°à§ à¦•à¦°à§à¦¨",
                
                // Profile/Settings
                referral_program: "à¦°à§‡à¦«à¦¾à¦°à§‡à¦² à¦ªà§à¦°à§‹à¦—à§à¦°à¦¾à¦®",
                invite_friends_earn: "à¦¬à¦¨à§à¦§à§à¦¦à§‡à¦° à¦†à¦®à¦¨à§à¦¤à§à¦°à¦£ à¦•à¦°à§à¦¨ à¦à¦¬à¦‚ à¦•à¦¯à¦¼à§‡à¦¨ à¦†à¦¯à¦¼ à¦•à¦°à§à¦¨",
                referral_earn_desc: "à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦¬à¦¨à§à¦§à§à¦° à¦œà¦¨à§à¦¯ à§«à§¦ à¦•à¦¯à¦¼à§‡à¦¨ à¦†à¦¯à¦¼ à¦•à¦°à§à¦¨",
                referral_instructions: "à¦¬à¦¨à§à¦§à§à¦¦à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦°à§‡à¦«à¦¾à¦°à§‡à¦² à¦²à¦¿à¦‚à¦• à¦¶à§‡à¦¯à¦¼à¦¾à¦° à¦•à¦°à§à¦¨à¥¤ à¦¤à¦¾à¦°à¦¾ à¦†à¦ªà¦¨à¦¾à¦° à¦²à¦¿à¦‚à¦• à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦¯à§‹à¦—à¦¦à¦¾à¦¨ à¦•à¦°à¦²à§‡ à¦†à¦ªà¦¨à¦¿ à§«à§¦ à¦•à¦¯à¦¼à§‡à¦¨ à¦ªà¦¾à¦¬à§‡à¦¨!",
                tap_to_copy: "à¦•à¦ªà¦¿ à¦•à¦°à¦¤à§‡ à¦Ÿà§à¦¯à¦¾à¦ª à¦•à¦°à§à¦¨",
                contact_support: "à¦¸à¦¾à¦ªà§‹à¦°à§à¦Ÿà§‡ à¦¯à§‹à¦—à¦¾à¦¯à§‹à¦— à¦•à¦°à§à¦¨",
                get_help: "à¦¯à§‡à¦•à§‹à¦¨ à¦¸à¦®à¦¸à§à¦¯à¦¾à¦¯à¦¼ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦ªà¦¾à¦¨",
                about: "à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡",
                about_microearn: "à¦®à¦¾à¦‡à¦•à§à¦°à§‹à¦‡à¦¯à¦¼à¦¾à¦°à§à¦¨ à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡",
                
                // Admin
                admin_panel: "à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦ªà§à¦¯à¦¾à¦¨à§‡à¦²",
                admin_controls: "à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨à¦¿à¦¸à§à¦Ÿà§à¦°à§‡à¦Ÿà¦° à¦•à¦¨à§à¦Ÿà§à¦°à§‹à¦²",
                
                // Notifications
                earned_coins: "{{amount}} à¦•à¦¯à¦¼à§‡à¦¨ à¦†à¦¯à¦¼ à¦•à¦°à§‡à¦›à§‡à¦¨!",
                daily_bonus_claimed: "à¦¦à§ˆà¦¨à¦¿à¦• à¦¬à§‹à¦¨à¦¾à¦¸ à¦¨à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡! {{amount}} à¦•à¦¯à¦¼à§‡à¦¨",
                insufficient_balance: "à¦…à¦ªà¦°à§à¦¯à¦¾à¦ªà§à¦¤ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸",
                withdrawal_requested: "à¦‰à¦¤à§à¦¤à§‹à¦²à¦¨à§‡à¦° à¦…à¦¨à§à¦°à§‹à¦§ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦œà¦®à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡",
                cooldown_active: "à¦•à§à¦²à¦¡à¦¾à¦‰à¦¨ à¦¸à¦•à§à¦°à¦¿à¦¯à¦¼",
                already_claimed: "à¦†à¦œ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦¨à§‡à¦“à¦¯à¦¼à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡",
                copied_to_clipboard: "à¦•à§à¦²à¦¿à¦ªà¦¬à§‹à¦°à§à¦¡à§‡ à¦•à¦ªà¦¿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡!",
                referral_copied: "à¦°à§‡à¦«à¦¾à¦°à§‡à¦² à¦²à¦¿à¦‚à¦• à¦•à¦ªà¦¿ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡!",
                
                // Surveys
                surveys: "à¦¸à¦¾à¦°à§à¦­à§‡",
                survey_earn_desc: "à¦ªà§à¦°à¦¤à¦¿ à¦¸à¦¾à¦°à§à¦­à§‡à¦¤à§‡ à§§à§¦à§¦-à§«à§¦à§¦ à¦•à¦¯à¦¼à§‡à¦¨ à¦†à¦¯à¦¼ à¦•à¦°à§à¦¨",
                other_ways: "à¦†à¦¯à¦¼à§‡à¦° à¦…à¦¨à§à¦¯à¦¾à¦¨à§à¦¯ à¦‰à¦ªà¦¾à¦¯à¦¼"
            }
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const tg = window.Telegram.WebApp;
        let userData = null;
        let selectedLanguage = 'en';
        let selectedTheme = 'dark';
        let currentPage = 'homePage';
        let historyPage = 1;
        let currentHistoryTab = 'all';
        
        // Error handling guards to prevent spam
        let lastErrorTime = 0;
        let errorCooldown = 3000; // 3 seconds between error notifications
        let isLoading = false;

        // ============================================
        // LANGUAGE SYSTEM FUNCTIONS
        // ============================================
        function loadLanguage() {
            const savedLang = localStorage.getItem('microearn_language');
            if (savedLang) {
                selectedLanguage = savedLang;
                applyLanguage();
            } else {
                // First time user - show language modal
                showLanguageModal();
            }
        }

        function applyLanguage() {
            document.documentElement.lang = selectedLanguage;
            document.body.classList.toggle('bn', selectedLanguage === 'bn');
            
            // Update all translatable elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[selectedLanguage][key]) {
                    element.textContent = translations[selectedLanguage][key];
                }
            });
            
            // Update current language display
            const currentLangEl = document.getElementById('currentLanguage');
            if (currentLangEl) {
                currentLangEl.textContent = selectedLanguage === 'bn' ? 'à¦¬à¦¾à¦‚à¦²à¦¾' : 'English';
            }
            
            localStorage.setItem('microearn_language', selectedLanguage);
        }

        function showLanguageModal() {
            document.getElementById('languageModal').classList.add('active');
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === selectedLanguage);
            });
        }

        function saveLanguage() {
            const selected = document.querySelector('.language-btn.active');
            if (selected) {
                selectedLanguage = selected.dataset.lang;
                applyLanguage();
                closeModal();
                loadUserData();
            }
        }

        function setLanguage(lang) {
            selectedLanguage = lang;
            applyLanguage();
            closeModal();
            showNotification(getTranslation('language') + ' ' + getTranslation('success'));
        }

        function openLanguageSettings() {
            document.getElementById('languageSettingsModal').classList.add('active');
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === selectedLanguage);
            });
        }

        function getTranslation(key, params = {}) {
            let text = translations[selectedLanguage][key] || translations.en[key] || key;
            Object.keys(params).forEach(param => {
                text = text.replace(`{{${param}}}`, params[param]);
            });
            return text;
        }

        // ============================================
        // THEME SYSTEM FUNCTIONS
        // ============================================
        function loadTheme() {
            const savedTheme = localStorage.getItem('microearn_theme');
            if (savedTheme) {
                selectedTheme = savedTheme;
            }
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', selectedTheme);
            
            const currentThemeEl = document.getElementById('currentTheme');
            if (currentThemeEl) {
                currentThemeEl.textContent = selectedTheme === 'dark' ? getTranslation('dark') : getTranslation('light');
            }
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === selectedTheme);
            });
            
            localStorage.setItem('microearn_theme', selectedTheme);
        }

        function changeTheme(theme) {
            selectedTheme = theme;
            applyTheme();
            closeModal();
            showNotification(getTranslation('theme') + ' ' + getTranslation('success'));
        }

        function openThemeSettings() {
            document.getElementById('themeModal').classList.add('active');
        }

        // ============================================
        // TELEGRAM USER DATA FUNCTIONS
        // Load user info from Telegram.WebApp.initDataUnsafe.user
        // ============================================
        function loadTelegramUser() {
            const user = tg.initDataUnsafe.user;
            if (user) {
                document.getElementById('userName').textContent = 
                    [user.first_name, user.last_name].filter(Boolean).join(' ');
                document.getElementById('userUsername').textContent = 
                    user.username ? `@${user.username}` : '';
                document.getElementById('profileName').textContent = 
                    [user.first_name, user.last_name].filter(Boolean).join(' ');
                document.getElementById('profileUsername').textContent = 
                    user.username ? `@${user.username}` : '';
                
                if (user.photo_url) {
                    document.getElementById('userAvatar').src = user.photo_url;
                    document.getElementById('profileAvatar').src = user.photo_url;
                } else {
                    // Default avatar if no photo
                    const defaultAvatar = 'https://ui-avatars.com/api/?name=' + 
                        encodeURIComponent(user.first_name || 'User') + '&background=0088cc&color=fff';
                    document.getElementById('userAvatar').src = defaultAvatar;
                    document.getElementById('profileAvatar').src = defaultAvatar;
                }
                
                document.getElementById('profileSection').style.display = 'block';
                document.querySelectorAll('.skeleton').forEach(el => el.classList.remove('skeleton'));
            }
        }

        // ============================================
        // API INTEGRATION FUNCTIONS
        // Note: Backend endpoints remain unchanged
        // ============================================
        async function loadUserData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const initData = tg.initData;
                const response = await fetch('https://microearn.abusaifeshovon.workers.dev/api/user', {
                    headers: { 'Authorization': `Bearer ${initData}` }
                });
                
                if (!response.ok) {
                    // Don't show error on initial load to prevent spam
                    if (userData) {
                        throw new Error('API request failed');
                    }
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    userData = data.data;
                    updateUI();
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                // Error guard: Only show notification if not in cooldown
                if (Date.now() - lastErrorTime > errorCooldown) {
                    showNotification(getTranslation('error'), true);
                    lastErrorTime = Date.now();
                }
            } finally {
                isLoading = false;
            }
        }

        function updateUI() {
            if (!userData) return;
            
            // Update balance
            document.getElementById('balanceAmount').textContent = userData.balance;
            document.getElementById('balanceSub').textContent = 
                `${userData.balance} coins = ${Math.floor(userData.balance / 10)} BDT`;
            document.getElementById('walletBalance').textContent = userData.balance;
            document.getElementById('walletSub').textContent = 
                `${userData.balance} coins = ${Math.floor(userData.balance / 10)} BDT`;
            
            // Update stats
            document.getElementById('todayEarnings').textContent = userData.today_earnings;
            document.getElementById('totalEarnings').textContent = userData.total_earned;
            document.getElementById('referralCount').textContent = userData.referral_count || 0;
            document.getElementById('pendingWithdrawal').textContent = userData.pending_withdrawal || 0;
            
            // Update quick actions
            updateQuickActions();
            
            // Update daily bonus amount
            if (userData.daily_bonus) {
                document.getElementById('dailyBonusAmount').textContent = `+${50 + Math.min(userData.daily_bonus.streak_days * 10, 100)}`;
                document.getElementById('dailyBonusQuick').textContent = `+${50 + Math.min(userData.daily_bonus.streak_days * 10, 100)}`;
            }
            
            // Show admin panel button if user is admin
            if (userData.is_admin) {
                document.getElementById('adminPanelBtn').style.display = 'flex';
            }
            
            // Update referral code
            if (userData.user_id) {
                const referralLink = `https://t.me/${tg.initDataUnsafe.user?.username || 'your_bot'}?startapp=ref_${userData.user_id}`;
                document.getElementById('referralCode').textContent = referralLink;
            }
            
            document.getElementById('balanceCard').classList.remove('skeleton');
        }

        function updateQuickActions() {
            if (!userData || !userData.ad_cooldowns) return;
            
            const now = new Date();
            const videoAdCooldown = userData.ad_cooldowns.video_ad;
            
            if (videoAdCooldown) {
                const lastWatched = new Date(videoAdCooldown);
                const cooldownEnd = new Date(lastWatched.getTime() + 5 * 60000);
                
                if (cooldownEnd > now) {
                    const minutesLeft = Math.ceil((cooldownEnd - now) / 60000);
                    document.getElementById('videoCooldown').textContent = 
                        `${minutesLeft}m ${getTranslation('cooldown_active').toLowerCase()}`;
                    document.getElementById('videoAdCard').classList.add('disabled');
                    document.getElementById('videoAdQuick').classList.add('disabled');
                } else {
                    document.getElementById('videoCooldown').textContent = getTranslation('ready');
                    document.getElementById('videoAdCard').classList.remove('disabled');
                    document.getElementById('videoAdQuick').classList.remove('disabled');
                }
            }
            
            // Update daily bonus status
            if (userData.daily_bonus) {
                const today = new Date().toDateString();
                const lastClaimed = userData.daily_bonus.last_claimed ? 
                    new Date(userData.daily_bonus.last_claimed).toDateString() : null;
                
                if (lastClaimed === today) {
                    document.getElementById('dailyBonusStatus').textContent = getTranslation('already_claimed');
                    document.getElementById('dailyBonusCard').classList.add('disabled');
                    document.getElementById('dailyBonusQuick').parentElement.classList.add('disabled');
                } else {
                    document.getElementById('dailyBonusStatus').textContent = getTranslation('claim_now');
                    document.getElementById('dailyBonusCard').classList.remove('disabled');
                    document.getElementById('dailyBonusQuick').parentElement.classList.remove('disabled');
                }
            }
        }

        async function watchAd(adType) {
            const card = document.getElementById('videoAdCard');
            if (card.classList.contains('disabled')) {
                showNotification(getTranslation('cooldown_active'), true);
                return;
            }
            
            try {
                const initData = tg.initData;
                const response = await fetch('https://microearn.abusaifeshovon.workers.dev/api/earn/ad', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ad_type: adType })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(getTranslation('earned_coins', { amount: data.reward }));
                    await loadUserData();
                } else {
                    showNotification(data.error || getTranslation('error'), true);
                }
            } catch (error) {
                showNotification(getTranslation('error'), true);
            }
        }

        async function claimDailyBonus() {
            const card = document.getElementById('dailyBonusCard');
            if (card.classList.contains('disabled')) {
                showNotification(getTranslation('already_claimed'), true);
                return;
            }
            
            try {
                const initData = tg.initData;
                const response = await fetch('https://microearn.abusaifeshovon.workers.dev/api/earn/daily-bonus', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${initData}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(getTranslation('daily_bonus_claimed', { amount: data.bonus }));
                    await loadUserData();
                } else {
                    // Backend fix needed: Daily bonus endpoint should return proper error JSON
                    // Currently returns "Internal Server Error" without proper JSON response
                    showNotification(data.error || getTranslation('error'), true);
                }
            } catch (error) {
                // Backend fix needed: /api/earn/daily-bonus should handle errors properly
                // and return user-friendly messages instead of 500 errors
                showNotification(getTranslation('error'), true);
            }
        }

        // ============================================
        // NAVIGATION FUNCTIONS
        // Single Page Application navigation
        // ============================================
        function navigateTo(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Map page IDs to nav items
            const navMap = {
                'homePage': 0,
                'earnPage': 1,
                'walletPage': 2,
                'historyPage': 3,
                'settingsPage': 4
            };
            
            if (navMap[pageId] !== undefined) {
                document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
            }
            
            // Update Telegram back button
            if (pageId === 'homePage') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
                tg.BackButton.onClick(() => navigateTo('homePage'));
            }
            
            currentPage = pageId;
            
            // Load page-specific data
            if (pageId === 'historyPage') {
                loadHistory();
            } else if (pageId === 'walletPage') {
                loadWithdrawalStatus();
            } else if (pageId === 'settingsPage') {
                // Hide any open cards in settings
                document.getElementById('aboutCard').style.display = 'none';
                document.getElementById('referralCard').style.display = 'none';
            }
        }

        // ============================================
        // HISTORY PAGE FUNCTIONS
        // New section for transaction history
        // ============================================
        function showHistoryTab(tab) {
            currentHistoryTab = tab;
            document.querySelectorAll('.history-tab').forEach(tabEl => tabEl.classList.remove('active'));
            event.target.classList.add('active');
            historyPage = 1;
            loadHistory();
        }

        async function loadHistory() {
            try {
                const initData = tg.initData;
                // Note: Backend needs to implement /api/history endpoint
                // This is a placeholder for future implementation
                const response = await fetch(`https://microearn.abusaifeshovon.workers.dev/api/history?page=${historyPage}&type=${currentHistoryTab}`, {
                    headers: { 'Authorization': `Bearer ${initData}` }
                });
                
                if (!response.ok) {
                    // If endpoint doesn't exist yet, show placeholder
                    showMockHistory();
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    displayHistory(data.data);
                    document.getElementById('loadMoreHistory').style.display = data.has_more ? 'block' : 'none';
                }
            } catch (error) {
                // Fallback to mock data if API fails
                showMockHistory();
            }
        }

        function showMockHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            // Mock history data for UI demonstration
            const mockHistory = [
                { type: 'daily_bonus', amount: 50, date: new Date().toISOString(), status: 'completed' },
                { type: 'ad', amount: 10, date: new Date(Date.now() - 86400000).toISOString(), status: 'completed' },
                { type: 'survey', amount: 150, date: new Date(Date.now() - 172800000).toISOString(), status: 'completed' },
                { type: 'withdrawal', amount: -1000, date: new Date(Date.now() - 259200000).toISOString(), status: 'pending' }
            ];
            
            mockHistory.forEach(item => {
                if (currentHistoryTab !== 'all' && 
                    currentHistoryTab === 'earnings' && item.type === 'withdrawal') return;
                if (currentHistoryTab !== 'all' && 
                    currentHistoryTab === 'withdrawals' && item.type !== 'withdrawal') return;
                
                const historyItem = createHistoryItem(item);
                historyList.appendChild(historyItem);
            });
            
            document.getElementById('loadMoreHistory').style.display = 'none';
        }

        function createHistoryItem(item) {
            const div = document.createElement('div');
            div.className = 'history-item';
            
            const typeNames = {
                'ad': getTranslation('watch_video_ad'),
                'survey': getTranslation('surveys'),
                'daily_bonus': getTranslation('daily_bonus'),
                'withdrawal': getTranslation('withdrawal')
            };
            
            const icons = {
                'ad': 'fa-video',
                'survey': 'fa-poll',
                'daily_bonus': 'fa-gift',
                'withdrawal': 'fa-wallet'
            };
            
            const date = new Date(item.date);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            div.innerHTML = `
                <div class="history-item-left">
                    <div class="history-icon ${item.type}">
                        <i class="fas ${icons[item.type]}"></i>
                    </div>
                    <div class="history-details">
                        <h4>${typeNames[item.type] || item.type}</h4>
                        <p>${formattedDate}</p>
                        ${item.status ? `<div class="history-status status-${item.status}">${item.status}</div>` : ''}
                    </div>
                </div>
                <div class="history-amount ${item.amount > 0 ? 'positive' : 'negative'}">
                    ${item.amount > 0 ? '+' : ''}${item.amount} coins
                </div>
            `;
            
            return div;
        }

        function loadMoreHistory() {
            historyPage++;
            loadHistory();
        }

        // ============================================
        // WALLET FUNCTIONS
        // ============================================
        async function loadWithdrawalStatus() {
            try {
                const initData = tg.initData;
                const response = await fetch('https://microearn.abusaifeshovon.workers.dev/api/withdrawals?status=pending', {
                    headers: { 'Authorization': `Bearer ${initData}` }
                });
                
                if (!response.ok) {
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.data.length > 0) {
                    displayWithdrawalStatus(data.data);
                }
            } catch (error) {
                // Silently fail - not critical
            }
        }

        function displayWithdrawalStatus(withdrawals) {
            const container = document.getElementById('withdrawalStatus');
            container.innerHTML = '';
            
            withdrawals.forEach(w => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-item-left">
                        <div class="history-icon withdrawal">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="history-details">
                            <h4>${w.method.toUpperCase()} Withdrawal</h4>
                            <p>${w.account_number} â€¢ ${new Date(w.created_at).toLocaleDateString()}</p>
                            <div class="history-status status-${w.status}">${w.status}</div>
                        </div>
                    </div>
                    <div class="history-amount negative">
                        -${w.amount} coins
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
        }

        function openWithdrawModal() {
            if (!userData || userData.balance < 1000) {
                showNotification(getTranslation('insufficient_balance'), true);
                return;
            }
            
            const formHtml = `
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="select_method">Select Method</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="theme-btn active" onclick="selectWithdrawMethod('bkash')" id="bkashBtn" style="flex: 1;">
                            <i class="fas fa-mobile-alt"></i>
                            <div style="margin-top: 8px;">bKash</div>
                        </button>
                        <button class="theme-btn" onclick="selectWithdrawMethod('nagad')" id="nagadBtn" style="flex: 1;">
                            <i class="fas fa-wallet"></i>
                            <div style="margin-top: 8px;">Nagad</div>
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="account_number">Account Number</label>
                    <input type="tel" id="withdrawAccount" class="form-input" placeholder="01XXXXXXXXX" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary);">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="amount_coins">Amount (Coins)</label>
                    <input type="number" id="withdrawAmount" class="form-input" min="1000" max="50000" step="100" value="1000" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary);">
                    <div style="font-size: 0.875rem; margin-top: 4px; color: var(--text-secondary);">
                        <span data-i18n="you_will_receive">You will receive:</span> <span id="withdrawBdt">100</span> BDT
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="submitWithdraw()" style="width: 100%; padding: 12px;">
                    <span data-i18n="submit_request">Submit Request</span>
                </button>
            `;
            
            document.getElementById('withdrawForm').innerHTML = formHtml;
            document.getElementById('withdrawModal').classList.add('active');
            applyLanguage();
            
            document.getElementById('withdrawAmount').addEventListener('input', updateWithdrawBDT);
        }

        function selectWithdrawMethod(method) {
            document.getElementById('bkashBtn').classList.toggle('active', method === 'bkash');
            document.getElementById('nagadBtn').classList.toggle('active', method === 'nagad');
        }

        function updateWithdrawBDT() {
            const amount = parseInt(document.getElementById('withdrawAmount').value) || 0;
            const bdt = Math.floor(amount / 10);
            document.getElementById('withdrawBdt').textContent = bdt;
        }

        async function submitWithdraw() {
            const account = document.getElementById('withdrawAccount').value.trim();
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            
            if (!/^(?:\+88)?01[3-9]\d{8}$/.test(account)) {
                showNotification(getTranslation('invalid_phone'), true);
                return;
            }
            
            if (amount < 1000 || amount > 50000) {
                showNotification(getTranslation('amount_range'), true);
                return;
            }
            
            if (amount > userData.balance) {
                showNotification(getTranslation('insufficient_balance'), true);
                return;
            }
            
            try {
                const initData = tg.initData;
                const method = document.querySelector('.theme-btn.active').textContent.trim().toLowerCase();
                const response = await fetch('https://microearn.abusaifeshovon.workers.dev/api/withdraw/request', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${initData}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        method: method,
                        account_number: account,
                        amount: amount
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(getTranslation('withdrawal_requested'));
                    closeModal();
                    await loadUserData();
                    if (currentPage === 'walletPage') {
                        loadWithdrawalStatus();
                    }
                } else {
                    showNotification(data.error || getTranslation('error'), true);
                }
            } catch (error) {
                showNotification(getTranslation('error'), true);
            }
        }

        // ============================================
        // REFERRAL SYSTEM FUNCTIONS
        // With fallback UI if backend data is missing
        // ============================================
        function openReferralSection() {
            document.getElementById('aboutCard').style.display = 'none';
            document.getElementById('referralCard').style.display = 'block';
        }

        function closeReferralSection() {
            document.getElementById('referralCard').style.display = 'none';
        }

        function copyReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(referralCode).then(() => {
                showNotification(getTranslation('referral_copied'));
            });
        }

        function shareReferral() {
            const referralCode = document.getElementById('referralCode').textContent;
            const shareText = getTranslation('join_me_on_microearn') + ' ' + referralCode;
            
            if (navigator.share) {
                navigator.share({
                    title: 'MicroEarn',
                    text: shareText,
                    url: referralCode
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showNotification(getTranslation('copied_to_clipboard'));
                });
            }
        }

        // ============================================
        // SETTINGS PAGE FUNCTIONS
        // ============================================
        function openAbout() {
            document.getElementById('referralCard').style.display = 'none';
            document.getElementById('aboutCard').style.display = 'block';
        }

        function closeAbout() {
            document.getElementById('aboutCard').style.display = 'none';
        }

        function contactSupport() {
            tg.openLink('https://t.me/microearnsupport');
        }

        function openAdminPanel() {
            tg.openLink('https://microearn-miniapp.pages.dev/admin.html');
        }

        function openSurveys() {
            tg.openLink('https://example.com/surveys');
        }

        function refreshData() {
            loadUserData();
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // With error guards to prevent spam
        // ============================================
        function showNotification(message, isError = false) {
            // Error guard: Prevent repeated error notifications
            if (isError && Date.now() - lastErrorTime < errorCooldown) {
                return;
            }
            
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
                notification.querySelector('i').className = 'fas fa-exclamation-circle';
                lastErrorTime = Date.now();
            } else if (message.includes('Error') || message.includes('Failed')) {
                notification.classList.add('error');
                notification.querySelector('i').className = 'fas fa-exclamation-circle';
                lastErrorTime = Date.now();
            } else {
                notification.querySelector('i').className = 'fas fa-check-circle';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Load theme and language
            loadTheme();
            loadLanguage();
            
            // Load Telegram user data
            loadTelegramUser();
            
            // Load initial user data
            loadUserData();
            
            // Initialize navigation
            navigateTo('homePage');
            
            // Setup auto-refresh every 60 seconds (not aggressive)
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    loadUserData();
                }
            }, 60000);
            
            // Handle visibility change
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    loadUserData();
                }
            });
        });

        // ============================================
        // BACKEND FIX COMMENTS
        // These comments indicate backend fixes needed
        // ============================================
        
        // 1. Daily Bonus Error Fix Needed:
        //    - Backend /api/earn/daily-bonus should return proper JSON error responses
        //    - Currently returns "Internal Server Error" without proper error format
        //    - Should return { success: false, error: "User-friendly message" }
        
        // 2. Referral System Fix Needed:
        //    - Backend must ensure referrals table has proper foreign key constraints
        //    - referrer_id logic should validate that referrer exists
        //    - /api/user endpoint should include referral_count and referral_code
        
        // 3. Error Spam Prevention:
        //    - Backend should implement proper error handling to avoid repeated 500 errors
        //    - Rate limiting on error endpoints to prevent spam
        //    - Consistent JSON error response format
        
        // 4. History Endpoint Needed:
        //    - Backend needs to implement /api/history endpoint
        //    - Should return paginated transaction history
        //    - Support filtering by type (earnings, withdrawals)
    </script>
</body>
</html>
